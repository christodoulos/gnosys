<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>NTUA Digital Twin Iframe</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <script type="text/javascript" src="/assets/js/geojson.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        'pk.eyJ1IjoiY2hyaXN0b2RvdWxvcyIsImEiOiJja3luYTd3eW0ydGFiMm9xcHRmMGJyOHVrIn0.c1mSurunkjU4Wyf2hxcy0g';
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/christodoulos/ckzichi5q001l15p1wpq6sbvs',
        center: [23.782529708901464, 37.97732290332949],
        zoom: 16,
        pitch: 45,
        bearing: -17.6,
        antialias: true,
      });

      map.on('load', async () => {
        // Get the initial location of the International Space Station (ISS).
        const geojson = await getLocation();
        // Add the ISS location as a source.
        map.addSource('iss', {
          type: 'geojson',
          data: geojson,
        });
        // Add the rocket symbol layer to the map.
        map.addLayer({
          id: 'iss',
          type: 'symbol',
          source: 'iss',
          layout: { 'icon-image': 'directions_bus_black_24dp' },
        });

        // Update the source from the API every 2 seconds.
        const updateSource = setInterval(async () => {
          const geojson = await getLocation(updateSource);
          map.getSource('iss').setData(geojson);
        }, 2000);

        async function getLocation(updateSource) {
          // Make a GET request to the API and return the location of the 242 buses.
          try {
            const response = await fetch('/api/hello', { method: 'GET' });
            const json = await response.json();
            const geojson = await GeoJSON.parse(json, {
              Point: ['CS_LAT', 'CS_LNG'],
            });
            console.log(geojson);
            return geojson;
          } catch (err) {
            // If the updateSource interval is defined, clear the interval to stop updating the source.
            if (updateSource) clearInterval(updateSource);
            throw new Error(err);
          }
        }
      });
    </script>
  </body>
</html>
